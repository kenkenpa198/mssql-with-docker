<!-- omit in toc -->
# 環境構築メモ

最終更新: 2022-10-24

WSL2 × Docker × MSSQL 環境の構築メモ。  
以下の環境・アプリケーションをインストールして連携させるのがゴール。

- WSL2（Ubuntu）
- Docker
- Docker Compose
- mssql-with-docker コンテナ
- Azure Data Studio

※ 個人用のメモとして作成したドキュメントです。  
※ 情報が古い可能性もありますので、参考にする場合は自己責任でお願いします。  
※ 「（オプション）」が見出しについている項目は必須の操作ではない工程です。

<!-- omit in toc -->
## 目次

- [1. 必要な環境の確認](#1-必要な環境の確認)
- [2. WSL2 環境の構築](#2-wsl2-環境の構築)
    - [2.1. WSL2 のインストール](#21-wsl2-のインストール)
    - [2.2. Ubuntu 環境の初期設定](#22-ubuntu-環境の初期設定)
    - [2.3. （オプション）WSL2 環境のリセット](#23-オプションwsl2-環境のリセット)
- [3. Docker のインストール](#3-docker-のインストール)
    - [3.1. Win 環境へ Docker Desktop をインストール](#31-win-環境へ-docker-desktop-をインストール)
    - [3.2. WSL2 環境へ Docker をインストール](#32-wsl2-環境へ-docker-をインストール)
    - [3.3. Docker の実行テスト](#33-docker-の実行テスト)
- [4. キャッシュファイルの削除](#4-キャッシュファイルの削除)
- [5. Docker Compose の実行確認](#5-docker-compose-の実行確認)
- [6. .env ファイルの作成](#6-env-ファイルの作成)
- [7. Azure Data Studio のインストール](#7-azure-data-studio-のインストール)
- [8. 実行テスト](#8-実行テスト)
- [9. アーカイブ](#9-アーカイブ)
    - [9.1. （オプション）Docker を sudo 無しでも実行できるようにする](#91-オプションdocker-を-sudo-無しでも実行できるようにする)

## 1. 必要な環境の確認

下記の環境であるか確認する。

- OS: Windows 10 バージョン 2004 以降 (ビルド 19041 以降) または Windows 11
    - `wsl` コマンド、`winget` コマンドの実行に必要なため。

## 2. WSL2 環境の構築

WSL2（Windows Subsystem for Linux 2）とは、Windows 10 上で仮想の Linux 環境を動作させるための仕組み。  
本手順では Ubuntu をインストールする。

参考:  
[WSL のインストール | Microsoft Learn](https://learn.microsoft.com/ja-jp/windows/wsl/install)

### 2.1. WSL2 のインストール

1. PowerShell を管理者権限で起動する。
2. 下記のコマンドを入力して送信する。

    ```shell
    wsl --install
    ```

3. インストールが開始するので、処理が完了するまで待つ。
4. 処理が完了したら、スタートメニューで `Ubuntu` と入力する。
5. スタートメニューに Ubuntu が表示されていればインストール完了。次の工程へ。

### 2.2. Ubuntu 環境の初期設定

1. スタートメニューから Ubuntu をクリックして起動する。
    1. ここで下記のエラーが出力される場合がある。

        ```shell
        Installing, this may take a few minutes...
        WslRegisterDistribution failed with error: 0x800701bc
        Error: 0x800701bc WSL 2 ???????????? ??????????????????????? https://aka.ms/wsl2kernel ?????????
        ```

    2. このエラーが出力された場合、エラーメッセージを控えた後に Ubuntu のウィンドウを閉じる。
    3. エラー内容に記載されている [https://aka.ms/wsl2kernel](https://aka.ms/wsl2kernel) へ遷移する。
    4. 遷移したページから「Linux カーネル更新プログラム パッケージ」をダウンロードする。
    5. ダウンロードしたパッケージをインストールする。
    6. インストール完了後、Ubuntu を再度立ち上げる。
2. `Installing, this may take a few minutes...` と表示されるので少し待つ。
3. しばらく待つとユーザー設定のため「UNIX username」と「password」の入力を求められるので、下記のように設定する。  
    1. `UNIX username` : ユーザー名。好みのものを入力して Enter キーで送信。※小文字のみ。
    2. `password` : パスワード。好みのものを入力して Enter キーで送信。  
    3. もう一度パスワードを入力するように指示されるので、もう一度入力して Enter キーで送信。  
4. シェルの表示が下記の状態になったら OK 。

    ```shell
    Installation successful!

    ...

    username@pc-name:~$
    ```

5. 下記のコマンドを送信し、Ubuntu 環境を最新版にアップデートする。

    ```shell
    $ sudo apt-get update && sudo apt-get upgrade -y
    ```

6. アップデートが完了したら一旦 Ubuntu ウィンドウを閉じてもう一回起動する。
7. 下記の順序でコマンドを入力して送信し、コマンドが正しく実行されることを確認する。

    ```shell
    $ cd     # ホームディレクトリへ移動する。
    $ ls -la # カレントディレクトリの内容を表示する。
    ```

※ 設定がうまくいかない場合、PC 本体の再起動を試す。

※ ユーザー設定の途中で Ubuntu を閉じてしまうと再設定が困難になる。  
この場合は [2.3. （オプション）WSL2 環境のリセット](#23-オプションwsl2-環境のリセット) に記載の手順を実行して環境を初期化する。  
初期化後、工程 1 からやり直す。

### 2.3. （オプション）WSL2 環境のリセット

環境構築の手順を間違えたり、環境を綺麗にしたいなどの理由で WSL2 環境を初期化したい場合がある。  
その場合は下記の手順でリセットを実行する。

1. Windows の設定を起動する。
2. `アプリ > アプリと機能 > Ubuntu > 詳細オプション` と遷移する。
3. `リセット` を実行する。Ubuntu 環境が初期化される。

初期化が完了したら、[2.2. Ubuntu 環境の初期設定](#22-ubuntu-環境の初期設定) の工程 1 から再実施する。

## 3. Docker のインストール

Docker とは、コンテナ型の仮想環境を作成、配布、実行するためのプラットフォームのこと。  
この工程では WSL2 上での Docker の実行環境を整え、MSSQL のコンテナを立ち上げられるようにする。

インストールできる Docker は2種類存在する。  
用途に合わせてどちらかの手順のみを実施する。

- [3.1. Win 環境へ Docker Desktop をインストール](#31-win-環境へ-docker-desktop-をインストール)
    - Win 環境へデスクトップ版の Docker「Docker Desktop」をインストールし、WSL2 と統合する場合。  
    インストールが簡単かつ GUI でも使えるので、個人で利用する場合はこちらが手軽。  
    - なお Docker Desktop は **一定基準を満たすと有料になる** 。商用利用の場合はライセンス違反に注意。  
        - 参考: [Docker Desktopの有料化が企業に与える影響と、企業における適切なDockerの利用方法 | by okash1n | Oct, 2022 | スタディスト Tech Blog](https://studist.tech/how-to-properly-use-docker-in-your-company-d5b3bf901e56)

- [3.2. WSL2 環境へ Docker をインストール](#32-wsl2-環境へ-docker-をインストール)
    - WSL2 の Ubuntu 環境へ Docker を直接インストールする場合。  
    Docker Desktop を使用できない場合はこちら。

### 3.1. Win 環境へ Docker Desktop をインストール

こちらの手順では Win 環境へデスクトップ版の Docker「Docker Desktop」をインストールし、WSL2 と統合する。
公式ドキュメントに沿ってインストールする。  
[Install Docker Desktop on Windows | Docker Documentation](https://docs.docker.com/desktop/install/windows-install/)

完了後、[3.3. Docker の実行テスト](#33-docker-の実行テスト) へ進む。

### 3.2. WSL2 環境へ Docker をインストール

こちらの手順では WSL2 の Ubuntu 環境へ Docker を直接インストールする。
公式ドキュメントに沿ってインストールする。  
[Install Docker Engine on Ubuntu | Docker Documentation](https://docs.docker.com/engine/install/ubuntu/)

ページ中の下記の見出しの手順を実施する。  

```text
# Installation methods
## Install using the repository
### Set up the repository
### Install Docker Engine ※

※ 手順 2 の「Install Docker Engine, containerd, and Docker Compose.」は対応方法が2種類ある。
最新の手順である「Latest」タブに記載の内容を進めて OK 。
```

※ Docker を過去にインストール済みの場合は古いバージョンのアンインストールが必要。  
`Uninstall old versions` 項の手順を先に行い、古いバージョンをアンインストールしておく。

完了後、[3.3. Docker の実行テスト](#33-docker-の実行テスト) へ進む。

### 3.3. Docker の実行テスト

Docker のインストールが完了後、下記の手順で実行テストを行う。

1. 下記のコマンドを送信する。

    ```shell
    $ sudo docker run hello-world
    [sudo] password for <<username>>: # パスワードを入力して送信する
    ```

    1. 下記のように言われたら Docker が Ubuntu 環境上で起動していないので……

        ```shell
        $ sudo docker run hello-world
        [sudo] password for <<username>>:
        docker: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?.
        ```

    2. Docker が起動中であるか確認し、起動していなければ起動する。

        ```shell
        $ sudo service docker status                # 確認
            * Docker is not running

        $ sudo service docker start                 # 起動する
            * Starting Docker: docker        [ OK ]

        $ sudo service docker status                # こう表示されれば OK
            * Docker is running

        $ sudo service docker stop                  # 止める場合はコレ
            * Stopping Docker: docker        [ OK ]
        ```

    3. もう一度 `sudo docker run hello-world` を実行する。

2. ビルドなどの処理が始まる。

    ```shell
    Unable to find image 'hello-world:latest' locally
    latest: Pulling FROM library/hello-world
    2db29710123e: Pull complete
    Digest: sha256:975f4b14f326b05db86e16de00144f9c12257553bba9484fed41f9b6f2257800
    Status: Downloaded newer image for hello-world:latest
    ...
    ```

3. 処理の完了後、下記のように表示されれば OK 。

    ```shell
    ...

    Hello FROM Docker!
    This message shows that your installation appears to be working correctly.
    ```

## 4. キャッシュファイルの削除

インストール関連の作業が完了後、`apt-get` コマンドによって生成されたキャッシュファイルを削除しておく。

```shell
$ sudo apt-get clean -y && sudo rm -rf /var/lib/apt/lists/*
```

## 5. Docker Compose の実行確認

Docker Compose とは、Docker コンテナ上で実行するアプリケーションを定義し、操作するためのツール。  
当 mssql-with-docker を実行するために必要。  

※ [3.2. WSL2 環境へ Docker をインストール](#32-wsl2-環境へ-docker-をインストール) を対応していた場合、「Install Docker Engine」項でインストール済み。  
起動テストのみを行う。

※ [3.1. Win 環境へ Docker Desktop をインストール](#31-win-環境へ-docker-desktop-をインストール) を対応していた場合でも実行可能な状態の見込みだが未検証。  
インストールする場合は公式ドキュメントを参照。  
[Install the Compose plugin | Docker Documentation](https://docs.docker.com/compose/install/linux/)

以下の手順で確認する。

1. 当リポジトリを clone して root ディレクトリへ移動する。

    ```shell
    $ git clone https://github.com/kenkenpa198/mssql-with-docker.git
    $ cd mssql-with-docker
    ```

2. コンテナを立ち上げる。

    ```shell
    $ docker-compose up -d
    ```

3. コンテナが起動しているか確認する。

    ```shell
    $ docker ps
    ```

## 6. .env ファイルの作成

パスワードを記述している `.env` ファイルを作成する。  
コンテナの立ち上げ時にこのパスワードが環境変数へ渡される。

1. ルートディレクトリに配置されている `.env.sample` を複製し、`.env` にリネームする。
2. `.env` 内の変数 `MSSQL_SA_PASSWORD` の値として指定している `<your_strong_password>` を好きなパスワードへ変更して保存する。
パスワードのルールは公式ドキュメントを参照: [パスワード ポリシー - SQL Server | Microsoft Learn](https://learn.microsoft.com/ja-jp/sql/relational-databases/security/password-policy?view=sql-server-ver15)

## 7. Azure Data Studio のインストール

Azure Data Studio とは、データベース操作を行うための Microsoft 製アプリケーション。  
Windows 環境から Docker コンテナ上のデータベースを操作するために使う。

1. PowerShell を開く
2. `winget` コマンドを送信しインストールする。

    ```shell
    $ winget install Microsoft.AzureDataStudio
    ```

3. MSSQL with Docker コンテナを稼働させておく。

4. （オプション）下記の記事を参考に日本語化設定を行う。
[Azure Data Studio - 日本語化する方法](https://www.curict.com/item/48/48b33f5.html)

5. `接続の追加` > `接続の詳細` へ下記のように設定。
    1. サーバー:
        1. Docker Desktop ありの場合: `localhost,11433` を入力。
        2. Docker Desktop なしの場合: `tcp:<<WSL2 の IP アドレス>>,11433` を入力 ※1
    2. 認証の種類: `SQL ログイン`
    3. ユーザー名: `sa`
    4. パスワード: `.env` に記述したパスワードを指定。
    5. パスワードを記憶する: お好みで設定。
    6. データベース: `<既定>`
    7. サーバー グループ: `<規定>`
    8. 名前 (省略可能): `好きな名前`
6. `接続` ボタンをクリック。
7. 左部のツリーへデータベースの情報が表示されたら完了。クエリを実行してみたりしてみる。

```text
※1
WSL2 の Ubuntu 環境へ Docker を直接インストールした場合、
ホスト OS となる WSL2 の IP アドレスをサーバーの接続先として指定する。

1. WSL2 上で「ip a | grep eth0 | grep inet」を送信する。
2. 「inet AAA.BBB.CCC.DDD/20 brd .....」という形式で IP アドレスが出力される。
3. この IP アドレスを基に「tcp:AAA.BBB.CCC.DDD,11433」の形式で指定する。

※ WSL2 を落とすとアドレスが変わるので、その度に設定の必要がある。
```

## 8. 実行テスト

ここまでの対応で環境構築は完了。

[README.md](README.md) へ掲載している、「2. 作業を開始するとき」「3. 作業を終了するとき」の操作を改めて試す。  
特に不自由なく操作が行えれば問題なし。

以上。
参考にさせていただいたサイトはまとめて [README.md](README.md) へ記載。

## 9. アーカイブ

過去に掲載していた作業内容を掲載。

### 9.1. （オプション）Docker を sudo 無しでも実行できるようにする

Docker は `sudo` を付与した実行でないと起動できない。  
これを `sudo` 無しでも実行できるようにしたい場合、ユーザーグループへユーザーを追加する。

**※ セキュリティ性を落とすことに繋がるため現在は推奨していない。**

1. Docker のユーザーグループを表示し、作業ユーザーが存在しないことを確認する

    ```shell
    $ getent group docker
    # 何も表示されない
    ```

2. Docker のユーザーグループへ作業ユーザーを追加する。

    ```shell
    $ sudo gpasswd -a <<username>> docker # <<username>> を設定したユーザー名に変更する
    ```

3. 再度 Docker のユーザーグループを表示し、作業ユーザーが追加されていることを確認する。

    ```shell
    $ getent group docker
    docker:x:1001:<<username>> # ユーザーが追加されている

    $ id <<username>> # id コマンドでも確認可能
    uid=1000(<<username>>) gid=1000(<<username>>) groups=1000(<<username>>),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),117(netdev),1001(docker)
    # 末尾に groups= ... ,1001(docker) とあるので、Docker グループに入れていることになる
    ```

4. Ubuntu を再起動する。

5. `sudo` 無しで実行可能か確認する。

    ```shell
    $ docker run hello-world
    ```
